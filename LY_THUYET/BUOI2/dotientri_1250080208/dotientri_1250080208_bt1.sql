CREATE USER dotientri_lab1 IDENTIFIED BY 123;
GRANT CONNECT, RESOURCE, UNLIMITED TABLESPACE TO dotientri_lab1;
CREATE USER dotientri IDENTIFIED BY 123;
CREATE USER tranthithanhthao IDENTIFIED BY 123;
GRANT CONNECT, RESOURCE, UNLIMITED TABLESPACE TO dotientri, tranthithanhthao;

CREATE TABLE HANGHANGKHONG (
    MAHANG VARCHAR2(10) PRIMARY KEY,
    TENHANG VARCHAR2(50),
    NGTL DATE,
    DUONGBAY NUMBER
);

CREATE TABLE CHUYENBAY (
    MACB VARCHAR2(10) PRIMARY KEY,
    MAHANG VARCHAR2(10),
    XUATPHAT VARCHAR2(50),
    DIEMDEN VARCHAR2(50),
    BATDAU DATE,
    TGBAY NUMBER,
    CONSTRAINT FK_CB_HHK FOREIGN KEY (MAHANG) REFERENCES HANGHANGKHONG(MAHANG)
);

CREATE TABLE NHANVIEN (
    MANV VARCHAR2(10) PRIMARY KEY,
    HOTEN VARCHAR2(50),
    GIOITINH VARCHAR2(5),
    NGSINH DATE,
    NGVL DATE,
    CHUYENMON VARCHAR2(20)
);

CREATE TABLE PHANCONG (
    MACB VARCHAR2(10),
    MANV VARCHAR2(10),
    NHIEMVU VARCHAR2(30),
    PRIMARY KEY (MACB, MANV),
    CONSTRAINT FK_PC_CB FOREIGN KEY (MACB) REFERENCES CHUYENBAY(MACB),
    CONSTRAINT FK_PC_NV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
);

ALTER SESSION SET NLS_DATE_FORMAT = 'DD/MM/YYYY HH24:MI';

INSERT INTO HANGHANGKHONG VALUES ('VN', 'Vietnam Airlines', TO_DATE('15/01/1956', 'DD/MM/YYYY'), 52);
INSERT INTO HANGHANGKHONG VALUES ('VJ', 'Vietjet Air', TO_DATE('25/12/2011', 'DD/MM/YYYY'), 33);
INSERT INTO HANGHANGKHONG VALUES ('BL', 'Jetstar Pacific Airlines', TO_DATE('01/12/1990', 'DD/MM/YYYY'), 13);

INSERT INTO NHANVIEN VALUES ('NV01', 'Lam Van Ben', 'Nam', TO_DATE('10/09/1991', 'DD/MM/YYYY'), TO_DATE('05/06/2021', 'DD/MM/YYYY'), 'Phi cong');
INSERT INTO NHANVIEN VALUES ('NV02', 'Duong Thi Luc', 'Nu', TO_DATE('22/03/1989', 'DD/MM/YYYY'), TO_DATE('12/11/2020', 'DD/MM/YYYY'), 'Tiep vien');
INSERT INTO NHANVIEN VALUES ('NV03', 'Hoang Thanh Tung', 'Nam', TO_DATE('29/07/1995', 'DD/MM/YYYY'), TO_DATE('11/04/2022', 'DD/MM/YYYY'), 'Tiep vien');
INSERT INTO NHANVIEN VALUES ('NV04', 'Do Tien Tri', 'Nam', TO_DATE('05/01/2000', 'DD/MM/YYYY'), TO_DATE('01/01/2024', 'DD/MM/YYYY'), 'Phi cong');

INSERT INTO CHUYENBAY VALUES ('VN550', 'VN', 'TP.HCM', 'Singapore', TO_DATE('20/12/2025 13:15', 'DD/MM/YYYY HH24:MI'), 2);
INSERT INTO CHUYENBAY VALUES ('VJ331', 'VJ', 'Da Nang', 'Vinh', TO_DATE('28/12/2025 22:30', 'DD/MM/YYYY HH24:MI'), 1);
INSERT INTO CHUYENBAY VALUES ('BL696', 'BL', 'TP.HCM', 'Da Lat', TO_DATE('24/12/2025 06:00', 'DD/MM/YYYY HH24:MI'), 0.5);

INSERT INTO PHANCONG VALUES ('VN550', 'NV01', 'Co truong');
INSERT INTO PHANCONG VALUES ('VN550', 'NV02', 'Tiep vien');
INSERT INTO PHANCONG VALUES ('BL696', 'NV03', 'Tiep vien truong');
INSERT INTO PHANCONG VALUES ('VJ331', 'NV04', 'Co pho');
COMMIT;

ALTER TABLE NHANVIEN ADD CONSTRAINT CHK_CHUYENMON CHECK (CHUYENMON IN ('Phi cong', 'Tiep vien'));

CREATE OR REPLACE TRIGGER TRG_BATDAU_NGTL
BEFORE INSERT OR UPDATE ON CHUYENBAY
FOR EACH ROW
DECLARE 
    v_ngtl DATE;
BEGIN
    SELECT NGTL INTO v_ngtl FROM HANGHANGKHONG WHERE MAHANG = :NEW.MAHANG;
    IF (:NEW.BATDAU <= v_ngtl) THEN
        RAISE_APPLICATION_ERROR(-20001, 'Loi: Ngay bay phai sau ngay thanh lap hang!');
    END IF;
END;
/

SELECT * FROM NHANVIEN WHERE EXTRACT(MONTH FROM NGSINH) = 7;

SELECT * FROM (
    SELECT MACB, COUNT(MANV) AS SO_NV 
    FROM PHANCONG 
    GROUP BY MACB 
    ORDER BY SO_NV DESC
) WHERE ROWNUM = 1;

SELECT H.TENHANG, COUNT(C.MACB) AS SO_CB
FROM HANGHANGKHONG H
LEFT JOIN CHUYENBAY C ON H.MAHANG = C.MAHANG AND C.XUATPHAT = 'Da Nang'
WHERE C.MACB IN (SELECT MACB FROM PHANCONG GROUP BY MACB HAVING COUNT(MANV) < 2) 
   OR C.MACB IS NULL
GROUP BY H.TENHANG;

SELECT * FROM NHANVIEN NV
WHERE NOT EXISTS (
    SELECT MACB FROM CHUYENBAY
    MINUS
    SELECT MACB FROM PHANCONG PC WHERE PC.MANV = NV.MANV
);

CREATE TABLE dotientri.XE_MAY (MAXE VARCHAR2(10) PRIMARY KEY, TENXE VARCHAR2(50));
CREATE TABLE dotientri.PHU_TUNG (MAPT VARCHAR2(10) PRIMARY KEY, TENPT VARCHAR2(50));
CREATE TABLE dotientri.BAO_DUONG (MABD VARCHAR2(10) PRIMARY KEY, NGAY_BD DATE);

INSERT INTO dotientri.XE_MAY VALUES ('W_X', 'Winner X');
INSERT INTO dotientri.PHU_TUNG VALUES ('PT01', 'Nhong sen dia');
INSERT INTO dotientri.BAO_DUONG VALUES ('BD01', TO_DATE('05/01/2026', 'DD/MM/YYYY'));
COMMIT;

GRANT SELECT, INSERT, UPDATE, DELETE ON dotientri.XE_MAY TO tranthithanhthao;
GRANT SELECT, INSERT, UPDATE, DELETE ON dotientri.PHU_TUNG TO tranthithanhthao;
GRANT SELECT, INSERT, UPDATE, DELETE ON dotientri.BAO_DUONG TO tranthithanhthao;

CREATE TABLE tranthithanhthao.KHACH_HANG (MAKH VARCHAR2(10) PRIMARY KEY, TENKH VARCHAR2(50));
CREATE TABLE tranthithanhthao.HOA_DON (MAHD VARCHAR2(10) PRIMARY KEY, TONGTIEN NUMBER);
CREATE TABLE tranthithanhthao.DAT_LICH (MADC VARCHAR2(10) PRIMARY KEY, NGAY_HEN DATE);

INSERT INTO tranthithanhthao.KHACH_HANG VALUES ('KH01', 'Do Tien Tri');
INSERT INTO tranthithanhthao.HOA_DON VALUES ('HD01', 500000);
INSERT INTO tranthithanhthao.DAT_LICH VALUES ('DL01', TO_DATE('10/01/2026', 'DD/MM/YYYY'));
COMMIT;

GRANT SELECT, INSERT, UPDATE, DELETE ON tranthithanhthao.KHACH_HANG TO dotientri;
GRANT SELECT, INSERT, UPDATE, DELETE ON tranthithanhthao.HOA_DON TO dotientri;
GRANT SELECT, INSERT, UPDATE, DELETE ON tranthithanhthao.DAT_LICH TO dotientri;

INSERT INTO dotientri.XE_MAY VALUES ('EX155', 'Exciter 155');
UPDATE dotientri.XE_MAY SET TENXE = 'Winner X 2026' WHERE MAXE = 'W_X';
DELETE FROM dotientri.XE_MAY WHERE MAXE = 'EX155';
COMMIT;

INSERT INTO tranthithanhthao.KHACH_HANG VALUES ('KH02', 'Nguyen Van A');
UPDATE tranthithanhthao.KHACH_HANG SET TENKH = 'Tran Thi Thanh Thao' WHERE MAKH = 'KH02';
DELETE FROM tranthithanhthao.KHACH_HANG WHERE MAKH = 'KH02';
COMMIT;